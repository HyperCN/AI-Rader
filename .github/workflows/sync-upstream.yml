name: Sync Upstream TrendRadar
on:
  workflow_dispatch:  # 手动触发
  schedule:
    - cron: '0 3 * * *'  # 定时触发（UTC每天3点）

# 仅授予必要权限（最小权限原则）
permissions:
  contents: write  # 允许推送代码
  issues: write    # 允许创建Issue（冲突通知用）

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout current repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 拉取完整历史，方便合并
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git user
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/sansan0/TrendRadar.git
          git remote -v

      - name: Fetch upstream updates
        run: git fetch upstream

      - name: Merge upstream into current branch (自动处理冲突)
        run: |
          # 切换到主分支（根据实际分支名调整，如master）
          git checkout master
          # 尝试合并上游main分支（第一次合并需--allow-unrelated-histories）
          if git merge upstream/master --allow-unrelated-histories --no-edit; then
            echo "合并成功，无冲突！"
          else
            echo "合并出现冲突，开始自动解决..."
            # ========== 核心：自动解决冲突 ==========
            # 方案A：使用上游代码覆盖所有冲突文件（推荐，同步上游最新修改）
            git checkout --theirs .  # --theirs 表示上游（upstream）的版本
            # 方案B：使用本地代码覆盖所有冲突文件（保留本地修改，仅同步无冲突部分）
            # git checkout --ours .  # --ours 表示本地（origin）的版本
            # ========== 冲突解决后提交 ==========
            git add .  # 标记冲突已解决
            git commit -m "chore: auto resolve merge conflicts from upstream [skip ci]"  # 提交解决后的代码
            echo "冲突已自动解决并提交！"
          fi

      - name: Push to current repo
        run: git push origin main
